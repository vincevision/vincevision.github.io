
//+------------------------------------------------------------------+
//|                                              VinceVision_9_21.mq5|
//|                                  Copyright 2026, AI Collaborator |
//+------------------------------------------------------------------+
#property strict
#include <Trade\Trade.mqh>

// --- Input Parameters ---
input group "EMA Settings"
input int      InpEMA5  = 5;   // Exit EMA
input int      InpEMA9  = 9;   // Fast EMA (Entry)
input int      InpEMA21 = 21;  // Slow EMA (Entry)

input group "Risk Management"
input double   InpLots  = 0.1; // Fixed Lot Size

// --- Global Variables ---
int      hEMA5, hEMA9, hEMA21;
CTrade   trade;
double   crossoverSL = 0;

//+------------------------------------------------------------------+
//| Initialization                                                   |
//+------------------------------------------------------------------+
int OnInit()
{
    hEMA5  = iMA(_Symbol, _Period, InpEMA5,  0, MODE_EMA, PRICE_CLOSE);
    hEMA9  = iMA(_Symbol, _Period, InpEMA9,  0, MODE_EMA, PRICE_CLOSE);
    hEMA21 = iMA(_Symbol, _Period, InpEMA21, 0, MODE_EMA, PRICE_CLOSE);
    
    trade.SetExpertMagicNumber(921);
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| Main Logic                                                       |
//+------------------------------------------------------------------+
void OnTick()
{
    double e5[], e9[], e21[];
    ArraySetAsSeries(e5, true); ArraySetAsSeries(e9, true); ArraySetAsSeries(e21, true);
    
    if(CopyBuffer(hEMA5,0,0,3,e5)<3 || CopyBuffer(hEMA9,0,0,3,e9)<3 || CopyBuffer(hEMA21,0,0,3,e21)<3) return;

    // --- Entry Logic (9/21 Crossover) ---
    bool longCross  = e9[1] > e21[1] && e9[2] <= e21[2];
    bool shortCross = e9[1] < e21[1] && e9[2] >= e21[2];

    // --- Check for Open Positions ---
    if(!PositionSelect(_Symbol)) 
    {
        if(longCross) 
        {
            crossoverSL = iLow(_Symbol, _Period, 1); // SL at crossover bar low
            trade.Buy(InpLots, _Symbol, SymbolInfoDouble(_Symbol, SYMBOL_ASK), crossoverSL, 0, "ENTRY");
            CreateLabel("VinceEntry", "ENTRY", clrGreen, true);
        }
        else if(shortCross) 
        {
            crossoverSL = iHigh(_Symbol, _Period, 1); // SL at crossover bar high
            trade.Sell(InpLots, _Symbol, SymbolInfoDouble(_Symbol, SYMBOL_BID), crossoverSL, 0, "ENTRY");
            CreateLabel("VinceEntry", "ENTRY", clrRed, false);
        }
    }
    else 
    {
        // --- Exit Logic (5/9 Crossover) ---
        long type = PositionGetInteger(POSITION_TYPE);
        
        bool longExit  = (type == POSITION_TYPE_BUY)  && (e5[1] < e9[1] && e5[2] >= e9[2]);
        bool shortExit = (type == POSITION_TYPE_SELL) && (e5[1] > e9[1] && e5[2] <= e9[2]);

        if(longExit || shortExit) 
        {
            trade.PositionClose(_Symbol);
            CreateLabel("VinceExit", "EXIT", clrOrange, (longExit ? false : true));
        }
    }
}

//+------------------------------------------------------------------+
//| Helper to create Chart Labels                                    |
//+------------------------------------------------------------------+
void CreateLabel(string name, string text, color clr, bool below)
{
    string labelName = name + IntegerToString(TimeCurrent());
    ObjectCreate(0, labelName, OBJ_TEXT, 0, TimeCurrent(), (below ? iLow(_Symbol,_Period,0) : iHigh(_Symbol,_Period,0)));
    ObjectSetString(0, labelName, OBJPROP_TEXT, text);
    ObjectSetInteger(0, labelName, OBJPROP_COLOR, clr);
    ObjectSetInteger(0, labelName, OBJPROP_ANCHOR, (below ? ANCHOR_TOP : ANCHOR_BOTTOM));
}
