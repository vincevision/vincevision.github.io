//+------------------------------------------------------------------+
//|                                     JujuieScalper_Pro_v2.mq5    |
//|                                  Copyright 2026, AI Collaborator |
//+------------------------------------------------------------------+
#property strict
#include <Trade\Trade.mqh>

input group "EMA Settings"
input int      EarlyEMA      = 5;          // Reversal Signal
input int      FastEMAPeriod = 9;          // Entry Signal
input int      SlowEMAPeriod = 21;         // Trend Baseline

input group "Money Management"
input double   RiskPercent   = 1.0;        
input int      StopLossPips  = 150;        

input group "Exit Settings"
input bool     UseEarlyExit  = true;       // Close trade on 5/9 reversal
input int      TP2_Pips      = 400;        

// --- Global Variables ---
int            hEarly, hFast, hSlow;
CTrade         trade;

int OnInit() {
    hEarly = iMA(_Symbol, _Period, EarlyEMA, 0, MODE_EMA, PRICE_CLOSE);
    hFast  = iMA(_Symbol, _Period, FastEMAPeriod, 0, MODE_EMA, PRICE_CLOSE);
    hSlow  = iMA(_Symbol, _Period, SlowEMAPeriod, 0, MODE_EMA, PRICE_CLOSE);
    return(INIT_SUCCEEDED);
}

void OnTick() {
    double e[], f[], s[];
    ArraySetAsSeries(e, true); ArraySetAsSeries(f, true); ArraySetAsSeries(s, true);
    if(CopyBuffer(hEarly,0,0,3,e)<3 || CopyBuffer(hFast,0,0,3,f)<3 || CopyBuffer(hSlow,0,0,3,s)<3) return;

    // 1. Position Management & Early Exit Logic
    if (PositionSelect(_Symbol)) {
        long type = PositionGetInteger(POSITION_TYPE);
        
        if (UseEarlyExit) {
            // If Long: Exit if 5 EMA crosses BELOW 9 EMA
            if (type == POSITION_TYPE_BUY && e[1] < f[1] && e[2] >= f[2]) {
                trade.PositionClose(_Symbol);
                Print("Early Exit: 5/9 Bearish Cross");
            }
            // If Short: Exit if 5 EMA crosses ABOVE 9 EMA
            if (type == POSITION_TYPE_SELL && e[1] > f[1] && e[2] <= f[2]) {
                trade.PositionClose(_Symbol);
                Print("Early Exit: 5/9 Bullish Cross");
            }
        }
        return;
    }

    // 2. Entry Logic (9/21 Cross)
    bool buySignal  = f[1] > s[1] && f[2] <= s[2];
    bool sellSignal = f[1] < s[1] && f[2] >= s[2];

    if (buySignal) {
        double sl = SymbolInfoDouble(_Symbol, SYMBOL_ASK) - StopLossPips * _Point;
        double tp = SymbolInfoDouble(_Symbol, SYMBOL_ASK) + TP2_Pips * _Point;
        trade.Buy(0.1, _Symbol, 0, sl, tp, "9/21 Entry");
    } else if (sellSignal) {
        double sl = SymbolInfoDouble(_Symbol, SYMBOL_BID) + StopLossPips * _Point;
        double tp = SymbolInfoDouble(_Symbol, SYMBOL_BID) - TP2_Pips * _Point;
        trade.Sell(0.1, _Symbol, 0, sl, tp, "9/21 Entry");
    }
}
